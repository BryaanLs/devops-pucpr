name: Notify Discord on Push

on:
  workflow_dispatch:
  push:

jobs:
  discord-notify:
    runs-on: ubuntu-latest

    steps:
      - name: Get commit details
        id: vars
        run: |
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV
          echo "COMMIT_URL=${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_ENV
          echo "BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV
          echo "REPO_NAME=${{ github.repository }}" >> $GITHUB_ENV

      - name: Send notification to Discord
        run: |
          curl -H "Content-Type: application/json" \
          -d '{
                "username": "GitHub Bot",
                "embeds": [{
                  "title": "New push to branch ${{ env.BRANCH }}",
                  "description": "**Commit Author:** ${{ env.COMMIT_AUTHOR }}\n**Commit Message:** ${{ env.COMMIT_MESSAGE }}",
                  "url": "${{ env.COMMIT_URL }}",
                  "color": 3447003,
                  "fields": [
                    {
                      "name": "Repository",
                      "value": "'${{ env.REPO_NAME }}'",
                      "inline": true
                    },
                    {
                      "name": "Branch",
                      "value": "'${{ env.BRANCH }}'",
                      "inline": true
                    },
                    {
                      "name": "Commit URL",
                      "value": "[View Commit](${COMMIT_URL})"
                    }
                  ],
                  "footer": {
                    "text": "GitHub Actions",
                    "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                  },
                  "timestamp": "'$(date --utc +%FT%TZ)'"
                }]
              }' \
          "$DISCORD_WEBHOOK"
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
